#!/usr/bin/env groovy

pipeline {
  agent {
    kubernetes {
      defaultContainer 'builder'
      inheritFrom 'builder-java11'
    }
  }

   parameters {
    string(name: 'VERSION', defaultValue: '21', description: 'Server Version')
    string(name: 'QUALIFIER', defaultValue: 'release', description: 'Image qualifier')
  }
  
  environment {
    S3_BUCKET = 'efris-swat-dev-js'
    S3_OBJECT = 'EFRIS_Offline_Mode_Enabler_for_Ubuntu_V' + VERSION + '.tar.gz'
    NEXUS_REGISTRY = 'nexus.example.com:8082'
  }

  stages {
    stage('Download from S3') {
      steps {
        withCredentials([
            [$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'efris_swat_dev_js_s3']
        ]) {
           sh '''
               echo "Creating tcs/config folder if not exists..."
               mkdir -p tcs/config

               echo "Downloading efris_server.tar.gz into tcs/config..."
               aws s3 cp s3://$S3_BUCKET/$S3_OBJECT tcs/config/efris_server.tar.gz

               echo "Verifying efris_server download..."
               ls -lh tcs/config/efris_server.tar.gz
             '''
        }
      }
    }

    stage('Build Docker Image') {
      steps {
        sh '''
          echo "Building Docker image..."
          docker build -t $NEXUS_REGISTRY/efris:$VERSION-$QUALIFIER .
        '''
      }
    }

    stage('Run Docker Container') {
      steps {
        sh '''
          echo "Running Docker container..."
          docker rm -f efris_container || true
          docker run -d --name efris_container -p 9880:9880 $NEXUS_REGISTRY/efris:$VERSION-$QUALIFIER
        '''
     }
    }

    stage('Push Docker Image to Nexus') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'nexus-docker-creds', usernameVariable: 'NEXUS_USER', passwordVariable: 'NEXUS_PASS')]) {
          sh '''
            echo "$NEXUS_PASS" | docker login $NEXUS_REGISTRY -u "$NEXUS_USER" --password-stdin
            docker push $NEXUS_REGISTRY/efris:$VERSION-$QUALIFIER
            docker logout $NEXUS_REGISTRY
          '''
        }
      }
    }
  }

  post {
      success {
        echo "Docker container started and image pushed successfully: $NEXUS_REGISTRY/efris:$VERSION-$QUALIFIER"
      }
      failure {
        echo "Pipeline failed. Check logs."
      }
    }
}
